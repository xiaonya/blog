<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://xiaonya.github.io/blog</id>
    <title>xiaonya Blog</title>
    <updated>2025-11-09T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="http://xiaonya.github.io/blog"/>
    <subtitle>xiaonya Blog</subtitle>
    <icon>http://xiaonya.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[K8S 安装详细步骤记录]]></title>
        <id>http://xiaonya.github.io/blog/2025-11-09-K8SInstall</id>
        <link href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall"/>
        <updated>2025-11-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[记录初学K8S时的安装步骤以及踩到的坑，供自己和他人参考。]]></summary>
        <content type="html"><![CDATA[<p>记录初学K8S时的安装步骤以及踩到的坑，供自己和他人参考。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="目标">目标<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#%E7%9B%AE%E6%A0%87" class="hash-link" aria-label="Direct link to 目标" title="Direct link to 目标" translate="no">​</a></h2>
<p>k8s集群，使用containerd作为容器运行时，calico作为网络插件，coredns作为dns服务，etcd作为集群存储。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="环境">环境<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 环境" title="Direct link to 环境" translate="no">​</a></h2>
<p>Fedora 42 <br>
<!-- -->Linux 6.16.8-200.fc42.x86_64</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="基本思路">基本思路<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF" class="hash-link" aria-label="Direct link to 基本思路" title="Direct link to 基本思路" translate="no">​</a></h2>
<ol>
<li class="">准备环境</li>
<li class="">安装containerd</li>
<li class="">配置ctr配置以及镜像源</li>
<li class="">安装kubeadm、kubelet、kubectl</li>
<li class="">初始化master节点</li>
<li class="">安装网络插件calico</li>
<li class="">加入worker节点</li>
<li class="">检查集群状态</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="详细步骤">详细步骤<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4" class="hash-link" aria-label="Direct link to 详细步骤" title="Direct link to 详细步骤" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-准备环境">1. 准备环境<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#1-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 1. 准备环境" title="Direct link to 1. 准备环境" translate="no">​</a></h3>
<ul>
<li class="">关闭swap，开启内核ip转发</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 1.关闭 swap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> swapoff </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/ swap / s/^\(.*\)$/#\1/g'</span><span class="token plain"> /etc/fstab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Fedora系统还需要关闭zram swap，其他系统不清楚</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 参考 FedoraDisableSWAP.md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2.加载内核模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 3.设置内核参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/k8s.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--system</span><br></span></code></pre></div></div>
<ul>
<li class="">关闭防火墙和selinux</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl disable </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> firewalld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> setenforce </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'s/^SELINUX=enforcing$/SELINUX=disabled/'</span><span class="token plain"> /etc/selinux/config</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-安装containerd运行时">2. 安装containerd运行时<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#2-%E5%AE%89%E8%A3%85containerd%E8%BF%90%E8%A1%8C%E6%97%B6" class="hash-link" aria-label="Direct link to 2. 安装containerd运行时" title="Direct link to 2. 安装containerd运行时" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> dnf </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> containerd</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-配置containerd">3. 配置containerd<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#3-%E9%85%8D%E7%BD%AEcontainerd" class="hash-link" aria-label="Direct link to 3. 配置containerd" title="Direct link to 3. 配置containerd" translate="no">​</a></h3>
<ul>
<li class="">生成默认配置文件</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span></code></pre></div></div>
<ul>
<li class="">修改配置文件/etc/containerd/config.toml</li>
<li class="">不能直接在文件尾部添加内容，需要找到对应位置进行修改，确认不存在才能直接添加</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 1. 使用SystemdCgroup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 参考https://github.com/containerd/containerd/blob/main/docs/cri/config.md#cgroup-driver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">plugins.</span><span class="token string" style="color:#e3116c">'io.containerd.cri.v1.runtime'</span><span class="token plain">.containerd.runtimes.runc.options</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SystemdCgroup </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. 配置阿里云镜像源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 参考1. https://github.com/containerd/containerd/blob/main/docs/cri/registry.md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 参考2. https://bychannel.github.io/containerd%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 参考3. https://help.aliyun.com/zh/acr/user-guide/accelerate-the-pulls-of-docker-official-images</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 需要自己确定containerd的版本号，接下来以containerd 2.x为例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 在cri配置文件中添加如下内容，指定镜像加速地址文件夹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">plugins.</span><span class="token string" style="color:#e3116c">"io.containerd.cri.v1.images"</span><span class="token plain">.registry</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   config_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/etc/containerd/certs.d"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建文件夹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> /etc/containerd/certs.d/docker.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建加速地址文件,该文件地址暂未找到官方文档说明</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 建议直接根据参考2创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 重启containerd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-安装kubeadmkubeletkubectl">4. 安装kubeadm、kubelet、kubectl<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#4-%E5%AE%89%E8%A3%85kubeadmkubeletkubectl" class="hash-link" aria-label="Direct link to 4. 安装kubeadm、kubelet、kubectl" title="Direct link to 4. 安装kubeadm、kubelet、kubectl" translate="no">​</a></h3>
<ul>
<li class="">添加kubernetes源</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 参考https://mirrors.ustc.edu.cn/help/kubernetes.html#yum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 执行如下命令（注意修改为自己需要的版本号）：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/yum.repos.d/kubernetes.repo</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[kubernetes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">name=Kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">baseurl=https://mirrors.ustc.edu.cn/kubernetes/core:/stable:/v1.34/rpm/</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">enabled=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">gpgcheck=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.34/rpm/repodata/repomd.xml.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果需要使用 CRI-O，执行以下命令：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/yum.repos.d/cri-o.repo</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[cri-o]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">name=CRI-O</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">baseurl=https://mirrors.ustc.edu.cn/kubernetes/addons:/cri-o:/stable:/v1.32/rpm/</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">enabled=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">gpgcheck=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/repodata/repomd.xml.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<ul>
<li class="">安装kubeadm、kubelet、kubectl</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> dnf </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> kubelet kubeadm kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> kubelet</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-初始化master节点">5. 初始化master节点<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#5-%E5%88%9D%E5%A7%8B%E5%8C%96master%E8%8A%82%E7%82%B9" class="hash-link" aria-label="Direct link to 5. 初始化master节点" title="Direct link to 5. 初始化master节点" translate="no">​</a></h3>
<blockquote>
<p>可以提前使用kubeadm config images list命令查看需要拉取的镜像，然后使用ctr命令提前拉取
一般来说指定镜像源后应该不会卡了，拉取的相关说明需要参考第6步的说明。</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> kubeadm init --image-repository registry.aliyuncs.com/google_containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 此处可能会卡在以下这种情况</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># [kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 这种情况往往是kubectl没有启动成功,无法验证安装是否成功，可以使用下面的命令查看kubelet日志,定位问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> journalctl </span><span class="token parameter variable" style="color:#36acaa">-xeu</span><span class="token plain"> kubelet </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 修好问题后执行以下命令重试</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> kubeadm reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> kubeadm init --image-repository registry.aliyuncs.com/google_containers</span><br></span></code></pre></div></div>
<ul>
<li class="">初始化流程结束后配置kubectl</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> /etc/kubernetes/admin.conf </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">id</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable parameter variable" style="color:#36acaa">-u</span><span class="token variable" style="color:#36acaa">)</span><span class="token builtin class-name">:</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">id</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable parameter variable" style="color:#36acaa">-g</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube/config</span><br></span></code></pre></div></div>
<ul>
<li class="">集群信息获取</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看安装的k8s版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看集群信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看各种组件版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get api-versions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看组件状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get componentstatuses</span><br></span></code></pre></div></div>
<ul>
<li class="">检查系统pod状态</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看所有命名空间的pod状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods </span><span class="token parameter variable" style="color:#36acaa">-A</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看指定命名空间的pod状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果看到有些pod状态非Running，可以使用下面的命令查错</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pod名称</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">命名空间</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<ul>
<li class="">将所有节点标记为可调度</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 处理以下警告使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Warning&nbsp; FailedScheduling&nbsp; 41s (x2 over 6m5s)&nbsp; default-scheduler&nbsp; 0/1 nodes are available: 1 node(s) had untolerated taint {node.kubernetes.io/not-ready: }. no new claims to deallocate, preemption: 0/1 nodes are available: 1 Preemption is not helpful for scheduling.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl taint nodes </span><span class="token parameter variable" style="color:#36acaa">--all</span><span class="token plain"> node-role.kubernetes.io/master-</span><br></span></code></pre></div></div>
<blockquote>
<p>在未安装网络插件前，pods和coredns的状态可能不是Ready和Running，这是正常的，将在下一步安装网络插件后解决。</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-安装网络插件calico">6. 安装网络插件calico<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#6-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6calico" class="hash-link" aria-label="Direct link to 6. 安装网络插件calico" title="Direct link to 6. 安装网络插件calico" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> https://docs.projectcalico.org/manifests/calico.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 接着使用第5步的检查系统pod状态指令，确认网络插件正常工作，且node状态为Ready，才算是集群正常工作</span><br></span></code></pre></div></div>
<blockquote>
<p>此处新手常遇到的问题是镜像未生效，containerd的操作方式与docker有所区别，接下来介绍如何使用ctr命令查看和拉取镜像。</p>
</blockquote>
<p>需要注意的几点：</p>
<ul>
<li class="">在ctr中存在命名空间的区分，默认使用的命名空间是default，而<strong>k8s使用的命名空间是k8s.io</strong>，所以想要查看k8s的镜像需要指定-n参数</li>
<li class="">ctr命令不会自动使用镜像源，需要指定–hosts-dir=/etc/containerd/certs.d</li>
<li class="">想要自动使用镜像源，可以使用crictl命令拉取</li>
<li class="">如果要确定此命令是否真的使用了镜像加速，可以增加–debug=true参数</li>
<li class="">ctr命令存在使用image的简写i的使用方式</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看所有镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ctr </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">镜像地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> images list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 拉取镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ctr </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> k8s.io images pull </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">镜像地址</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例如拉取coredns的镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr i pull --hosts-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/containerd/certs.d docker.io/calico/cni:v3.25.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr i pull --hosts-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/containerd/certs.d registry.k8s.io/sig-storage/csi-provisioner:v3.5.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看k8s.io命名空间下的所有镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> ctr </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> k8s.io i </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用crictl拉取镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> crictl pull </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">镜像地址</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-加入worker节点">7. 加入worker节点<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#7-%E5%8A%A0%E5%85%A5worker%E8%8A%82%E7%82%B9" class="hash-link" aria-label="Direct link to 7. 加入worker节点" title="Direct link to 7. 加入worker节点" translate="no">​</a></h3>
<p>正常完成前面的1-4步后，master节点已经可以正常工作了，接下来需要将worker节点加入集群，woker节点的1-4步操作与master节点相同，完成后执行以下操作：</p>
<ul>
<li class="">在master节点上获取新的token以及加入命令</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create --print-join-command</span><br></span></code></pre></div></div>
<ul>
<li class="">在worker节点上执行获取到的命令</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">master节点IP</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:6443 </span><span class="token parameter variable" style="color:#36acaa">--token</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --discovery-token-ca-cert-hash sha256:</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hash值</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例kubeadm join 192.168.0.62:6443 --token 8vm7ed.o0c8hd1sni050ujg --discovery-token-ca-cert-hash sha256:913eb08165815807a28e5b11b3d5c9f16541d4dc9cf36079e1d2ceed54690832</span><br></span></code></pre></div></div>
<ul>
<li class="">token相关命令</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建新的token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token delete </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">token</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-检查集群状态">8. 检查集群状态<a href="http://xiaonya.github.io/blog/2025-11-09-K8SInstall#8-%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81" class="hash-link" aria-label="Direct link to 8. 检查集群状态" title="Direct link to 8. 检查集群状态" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods </span><span class="token parameter variable" style="color:#36acaa">-A</span><br></span></code></pre></div></div>
<ul>
<li class="">如果需要删除集群，使用以下命令</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> kubeadm reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-rf</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl disable </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> dnf remove </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> kubelet kubeadm kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> dnf remove </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl disable </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> containerd</span><br></span></code></pre></div></div>]]></content>
        <author>
            <name>xiaonya</name>
            <uri>https://blog.xiaonya.com</uri>
        </author>
        <category label="K8S" term="K8S"/>
        <category label="containerd" term="containerd"/>
        <category label="calico" term="calico"/>
        <category label="kubeadm" term="kubeadm"/>
        <category label="getting-started" term="getting-started"/>
        <category label="tutorial" term="tutorial"/>
    </entry>
</feed>